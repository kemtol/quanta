<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <title>QQQUANTA – Verifikasi OTP</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Font Awesome untuk ikon telpon -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet" />
</head>

<body class="bg-light d-flex align-items-center justify-content-center" style="min-height:100vh;">
  <div class="container" style="max-width: 520px;">
    <div class="card shadow-sm">
      <div class="card-body p-4">
        <h1 class="h5 mb-2">Verifikasi Kode</h1>
        <p class="text-muted mb-3">
          Masukkan kode verifikasi yang dikirim ke WhatsApp kamu.
        </p>

        <div id="alert-area"></div>

        <div id="otp-content" class="d-none">
          <div class="mb-3">
            <div class="small text-muted mb-1">Nomor yang diverifikasi:</div>
            <div class="fw-semibold">
              <i class="fa-solid fa-phone me-1"></i>
              <span id="phone-label"></span>
            </div>
          </div>

          <!-- mock preview untuk dev -->
          <div id="otp-mock-box" class="mb-3 d-none">
            <div class="small text-muted mb-1">
              Simulasi WhatsApp (dev only):
            </div>
            <div class="badge bg-light text-dark border">
              Kode: <span id="otp-mock"></span>
            </div>
          </div>

          <form id="otp-form" novalidate>
            <div class="mb-3">
              <label for="otp" class="form-label">Kode Verifikasi (6 digit)</label>
              <input type="text" id="otp" class="form-control" maxlength="6" placeholder="Masukkan kode 6 digit"
                required />
              <div class="form-text">
                Jika kadaluarsa, minta kode baru dari halaman register.
              </div>
            </div>

            <button type="submit" id="otp-btn" class="btn btn-primary w-100">
              <span class="btn-text">Verifikasi</span>
              <span class="spinner-border spinner-border-sm ms-2 d-none" role="status"></span>
            </button>
          </form>
        </div>

        <div id="fallback-content" class="d-none">
          <div class="alert alert-warning mb-3">
            Tidak ditemukan data pendaftaran. Silakan mulai dari halaman register.
          </div>
          <a href="register.html" class="btn btn-primary w-100">Kembali ke Register</a>
        </div>
      </div>

      <div class="card-footer text-center small">
        Sudah punya akun? <a href="login.html">Login di sini</a>
      </div>
    </div>
  </div>

  <script>
    (function () {
      window.addEventListener("DOMContentLoaded", () => {
        console.log("[otp] init");

        const isLocal =
          location.hostname === "localhost" || location.hostname === "127.0.0.1";
        const AUTH_BASE = isLocal
          ? "http://127.0.0.1:8786"
          : "https://auth-uid.mkemalw.workers.dev";

        // HARUS sama dengan register.html
        const PENDING_KEY = "qqquanta_pending_register";

        const alertArea = document.getElementById("alert-area");
        const otpContent = document.getElementById("otp-content");
        const fallbackContent = document.getElementById("fallback-content");
        const phoneLabel = document.getElementById("phone-label");
        const otpMockBox = document.getElementById("otp-mock-box");
        const otpMockSpan = document.getElementById("otp-mock");
        const otpForm = document.getElementById("otp-form");
        const otpInput = document.getElementById("otp");
        const otpBtn = document.getElementById("otp-btn");
        const otpBtnText = otpBtn.querySelector(".btn-text");
        const otpSpinner = otpBtn.querySelector(".spinner-border");

        function showAlert(msg, type = "danger") {
          alertArea.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${msg}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
        }

        function clearAlert() {
          alertArea.innerHTML = "";
        }

        function setLoading(loading) {
          if (loading) {
            otpBtn.disabled = true;
            otpSpinner.classList.remove("d-none");
            otpBtnText.textContent = "Memverifikasi...";
          } else {
            otpBtn.disabled = false;
            otpSpinner.classList.add("d-none");
            otpBtnText.textContent = "Verifikasi";
          }
        }

        function loadPendingRegister() {
          try {
            const raw = localStorage.getItem(PENDING_KEY);
            return raw ? JSON.parse(raw) : null;
          } catch {
            return null;
          }
        }

        function clearPendingRegister() {
          try {
            localStorage.removeItem(PENDING_KEY);
          } catch {
            /* ignore */
          }
        }

        // ===== Ambil state dari register =====
        const pending = loadPendingRegister();

        if (!pending || !pending.phone) {
          // Tidak ada state → langsung tunjuk fallback (tanpa kedip)
          fallbackContent.classList.remove("d-none");
          return;
        }

        // Cek expiry lokal
        if (pending.expires_at && Date.now() > pending.expires_at) {
          clearPendingRegister();
          fallbackContent.classList.remove("d-none");
          return;
        }

        // Ada data → tampilkan form OTP (sekali saja)
        otpContent.classList.remove("d-none");
        phoneLabel.textContent = pending.phone;

        if (pending.mock_temp_password) {
          otpMockSpan.textContent = pending.mock_temp_password;
          otpMockBox.classList.remove("d-none");
        }

        // Fokuskan input OTP
        if (otpInput) {
          otpInput.focus();
        }

        async function verifyTempPassword(phone, otp) {
          const resp = await fetch(AUTH_BASE + "/verify-temp", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({
              phone: phone.trim(),
              temp_password: otp.trim(),
            }),
          });

          const data = await resp.json().catch(() => ({}));
          console.log("[otp] /verify-temp", resp.status, data);

          if (!resp.ok || !data.ok) {
            if (data.reason === "invalid_or_expired_temp_password") {
              clearPendingRegister();
              throw new Error(
                "Kode tidak valid atau sudah kadaluarsa. Silakan minta kode baru dari halaman register."
              );
            }
            if (data.reason === "missing_fields") {
              throw new Error("Kode atau nomor HP tidak lengkap.");
            }
            throw new Error(data.error || resp.statusText || "Gagal verifikasi kode.");
          }
          return data;
        }

        otpForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          clearAlert();

          const code = otpInput.value.trim();
          if (!code || code.length !== 6) {
            showAlert("Kode verifikasi harus 6 digit.", "warning");
            return;
          }

          setLoading(true);
          try {
            await verifyTempPassword(pending.phone, code);
            clearPendingRegister();
            showAlert("Verifikasi berhasil. Mengarahkan ke halaman profil...", "success");
            setTimeout(() => {
              window.location.href = "profile.html";
            }, 900);
          } catch (err) {
            console.error(err);
            showAlert(err.message || "Terjadi kesalahan saat verifikasi.", "danger");
          } finally {
            setLoading(false);
          }
        });
      });
    })();
  </script>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>